<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Character Manager</title>

<style>
:root{
    --bg-main:#0f1117;
    --bg-card:#1a1d26;
    --bg-accent:#232734;
    --accent:#5aa2ff;
    --danger:#ff5a7a;
    --radius:14px;
}

body{
    background:var(--bg-main);
    color:white;
    font-family:system-ui;
    padding:20px;
}

/* INPUTS */
input, textarea{
    width:100%;
    padding:14px;
    margin-bottom:16px;
    border-radius:var(--radius);
    border:none;
    background:var(--bg-card);
    color:white;
}

/* BUTTONS */
button{
    width:100%;
    padding:16px;
    border:none;
    border-radius:var(--radius);
    margin-bottom:12px;
    font-size:16px;
}

.saveBtn{ background:var(--accent); }
.deleteBtn{ background:var(--danger); }

/* IMAGE */
.avatarPreview{
    width:140px;
    height:140px;
    border-radius:50%;
    object-fit:cover;
    background:var(--bg-accent);
    display:block;
    margin:0 auto 16px auto;
}

/* CANVAS EDITOR */
#editorContainer{
    display:none;
    margin-bottom:20px;
}

canvas{
    width:260px;
    height:260px;
    border-radius:50%;
    display:block;
    margin:0 auto 10px auto;
    background:#000;
}

#zoomSlider{
    width:100%;
    margin-bottom:10px;
}
</style>
</head>

<body>

<h1>Edit Character</h1>

<img id="avatarPreview" class="avatarPreview">

<input type="file" id="charImage" accept="image/*">

<div id="editorContainer">
    <canvas id="imageCanvas" width="300" height="300"></canvas>
    <input type="range" id="zoomSlider" min="0.5" max="3" step="0.01" value="1">
    <button type="button" id="useImageBtn">Use Image</button>
</div>

<input id="charName" placeholder="Name">
<textarea id="charDesc" placeholder="Description"></textarea>
<input id="charTags" placeholder="Tags">
<input id="charFolder" placeholder="Folder">

<button class="saveBtn" id="saveBtn">Save Changes</button>
<button class="deleteBtn" id="deleteBtn">Delete Character</button>

<script>
/* ===== LOAD CHARACTER ===== */
let characters = JSON.parse(localStorage.getItem("characters")) || [];
let index = localStorage.getItem("editingCharacterIndex");
let char = characters[index];

let savedImageData = char?.image || null;

/* ===== ELEMENTS ===== */
const avatarPreview = document.getElementById("avatarPreview");
const fileInput = document.getElementById("charImage");
const editor = document.getElementById("editorContainer");
const canvas = document.getElementById("imageCanvas");
const ctx = canvas.getContext("2d");
const zoomSlider = document.getElementById("zoomSlider");
const useBtn = document.getElementById("useImageBtn");

/* ===== LOAD DATA INTO FORM ===== */
if(char){
    charName.value = char.name || "";
    charDesc.value = char.desc || "";
    charTags.value = char.tags || "";
    charFolder.value = char.folder || "";

    if(char.image){
        avatarPreview.src = char.image;
    }
}

/* ===== IMAGE EDITOR ===== */
let img = new Image();
let scale = 1;
let posX = 0;
let posY = 0;
let dragging = false;
let startX = 0;
let startY = 0;

fileInput.addEventListener("change", function(){
    const file = fileInput.files[0];
    if(!file) return;

    const reader = new FileReader();

    reader.onload = function(e){
        img.onload = function(){
            editor.style.display = "block";
            scale = 1;
            posX = 0;
            posY = 0;
            draw();
        };
        img.src = e.target.result;
    };

    reader.readAsDataURL(file);
});

function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    ctx.save();
    ctx.beginPath();
    ctx.arc(150,150,150,0,Math.PI*2);
    ctx.clip();

    ctx.drawImage(img, posX, posY, img.width*scale, img.height*scale);
    ctx.restore();
}

canvas.addEventListener("mousedown", startDrag);
canvas.addEventListener("touchstart", startDrag);

function startDrag(e){
    dragging = true;
    startX = e.offsetX || e.touches[0].clientX;
    startY = e.offsetY || e.touches[0].clientY;
}

canvas.addEventListener("mousemove", dragMove);
canvas.addEventListener("touchmove", dragMove);

function dragMove(e){
    if(!dragging) return;

    let x = e.offsetX || e.touches[0].clientX;
    let y = e.offsetY || e.touches[0].clientY;

    posX += x - startX;
    posY += y - startY;

    startX = x;
    startY = y;

    draw();
}

canvas.addEventListener("mouseup", ()=> dragging=false);
canvas.addEventListener("touchend", ()=> dragging=false);

zoomSlider.addEventListener("input", ()=>{
    scale = parseFloat(zoomSlider.value);
    draw();
});

useBtn.addEventListener("click", ()=>{
    savedImageData = canvas.toDataURL("image/png");
    avatarPreview.src = savedImageData;
    editor.style.display = "none";
});

/* ===== SAVE ===== */
saveBtn.onclick = () => {

    characters[index] = {
        name: charName.value,
        desc: charDesc.value,
        tags: charTags.value,
        folder: charFolder.value,
        image: savedImageData
    };

    localStorage.setItem("characters", JSON.stringify(characters));
    window.location.href = "character.html";
};

/* ===== DELETE ===== */
deleteBtn.onclick = () => {

    characters.splice(index, 1);

    localStorage.setItem("characters", JSON.stringify(characters));
    window.location.href = "character.html";
};
</script>

</body>
</html>
