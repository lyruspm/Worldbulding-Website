<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Character Manager</title>

<style>
:root{
    --bg-main:#0f1117;
    --bg-card:#1a1d26;
    --accent:#5aa2ff;
    --danger:#ff5a7a;
    --radius:14px;
}

body{
    background:var(--bg-main);
    color:white;
    font-family:system-ui;
    padding:20px;
}

h1{
    margin-bottom:20px;
}

/* AVATAR */
.avatarPreview{
    width:150px;
    height:150px;
    border-radius:50%;
    background:var(--bg-card);
    object-fit:cover;
    display:block;
    margin:0 auto 20px auto;
}

/* FORM */
input, textarea{
    width:100%;
    padding:14px;
    margin-bottom:16px;
    border-radius:var(--radius);
    border:none;
    background:var(--bg-card);
    color:white;
}

button{
    width:100%;
    padding:16px;
    border:none;
    border-radius:var(--radius);
    margin-bottom:12px;
    font-size:16px;
    cursor:pointer;
}

.saveBtn{ background:var(--accent); }
.deleteBtn{ background:var(--danger); }
.photoBtn{ background:#232734; }

/* EDITOR */
#editorContainer{
    display:none;
    margin-bottom:20px;
}

canvas{
    width:250px;
    height:250px;
    border-radius:50%;
    background:#1a1d26;
    display:block;
    margin:auto;
}

#zoomSlider{
    width:100%;
    margin:10px 0;
}
</style>
</head>

<body>

<h1>Edit Character</h1>

<img id="avatarPreview" class="avatarPreview">

<input type="file" id="charImage" accept="image/*">

<div id="editorContainer">
    <canvas id="imageCanvas" width="300" height="300"></canvas>
    <input type="range" id="zoomSlider" min="0.5" max="3" step="0.01" value="1">
    <button class="photoBtn" id="useImageBtn">Use This Image</button>
</div>

<input id="charName" placeholder="Name">
<textarea id="charDesc" placeholder="Description"></textarea>
<input id="charTags" placeholder="Tags">
<input id="charFolder" placeholder="Folder">

<button class="saveBtn" id="saveBtn">Save Changes</button>
<button class="deleteBtn" id="deleteBtn">Delete Character</button>

<script>
/* ===== LOAD CHARACTER ===== */
let characters = JSON.parse(localStorage.getItem("characters")) || [];
let index = localStorage.getItem("editingCharacterIndex");

if(index === null){
    window.location.replace("characters.html");
}

let char = characters[index];

const avatarPreview = document.getElementById("avatarPreview");

if(char){
    document.getElementById("charName").value = char.name || "";
    document.getElementById("charDesc").value = char.desc || "";
    document.getElementById("charTags").value = char.tags || "";
    document.getElementById("charFolder").value = char.folder || "";

    avatarPreview.src = char.image || "";
}

/* ===== IMAGE EDITOR ===== */
let savedImageData = char.image || null;

const fileInput = document.getElementById("charImage");
const canvas = document.getElementById("imageCanvas");
const ctx = canvas.getContext("2d");
const zoomSlider = document.getElementById("zoomSlider");
const editor = document.getElementById("editorContainer");
const useBtn = document.getElementById("useImageBtn");

let img = new Image();
let scale = 1;
let posX = 0;
let posY = 0;
let dragging = false;
let startX = 0;
let startY = 0;

fileInput.addEventListener("change", function(){
    const file = fileInput.files[0];
    if(!file) return;

    const reader = new FileReader();

    reader.onload = function(e){
        img.onload = function(){
            editor.style.display = "block";
            scale = 1;
            posX = 0;
            posY = 0;
            draw();
        };
        img.src = e.target.result;
    };

    reader.readAsDataURL(file);
});

function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.save();

    ctx.beginPath();
    ctx.arc(150,150,150,0,Math.PI*2);
    ctx.clip();

    ctx.drawImage(
        img,
        posX,
        posY,
        img.width * scale,
        img.height * scale
    );

    ctx.restore();
}

/* DRAG */
canvas.addEventListener("mousedown", e=>{
    dragging=true;
    startX=e.offsetX;
    startY=e.offsetY;
});

canvas.addEventListener("mousemove", e=>{
    if(!dragging) return;
    posX += e.offsetX - startX;
    posY += e.offsetY - startY;
    startX=e.offsetX;
    startY=e.offsetY;
    draw();
});

canvas.addEventListener("mouseup", ()=> dragging=false);

/* ZOOM */
zoomSlider.addEventListener("input", ()=>{
    scale=parseFloat(zoomSlider.value);
    draw();
});

/* CONFIRM IMAGE */
useBtn.addEventListener("click", ()=>{
    savedImageData = canvas.toDataURL("image/png");
    avatarPreview.src = savedImageData;
    editor.style.display = "none";
});

/* ===== SAVE CHARACTER ===== */
document.getElementById("saveBtn").onclick = () => {

    characters[index] = {
        name: document.getElementById("charName").value,
        desc: document.getElementById("charDesc").value,
        tags: document.getElementById("charTags").value,
        folder: document.getElementById("charFolder").value,
        image: savedImageData
    };

    localStorage.setItem("characters", JSON.stringify(characters));

    window.location.replace("characters.html");
};

/* ===== DELETE ===== */
document.getElementById("deleteBtn").onclick = () => {

    if(confirm("Delete this character?")){
        characters.splice(index,1);
        localStorage.setItem("characters", JSON.stringify(characters));
        window.location.replace("character.html");
    }
};
</script>

</body>
</html>
