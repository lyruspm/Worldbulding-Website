<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Character Manager</title>

<style>
/* =========================
   THEME TOKENS
========================= */
:root{
    --bg-main:#0f1117;
    --bg-card:#1a1d26;
    --bg-accent:#232734;

    --accent:#5aa2ff;
    --danger:#ff5a7a;

    --radius:14px;

    --space-xs:6px;
    --space-sm:10px;
    --space-md:16px;
    --space-lg:24px;

    --transition:0.18s ease;
}

/* =========================
   BASE
========================= */
*{
    box-sizing:border-box;
}

body{
    background:var(--bg-main);
    color:white;
    font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    padding:var(--space-lg);
    line-height:1.4;
}

/* =========================
   CARD LAYOUT (Optional)
========================= */
.card{
    background:var(--bg-card);
    border-radius:var(--radius);
    padding:var(--space-lg);
}

/* =========================
   INPUTS / TEXTAREAS / SELECT
========================= */
input,
textarea,
select{
    width:100%;
    padding:14px;
    margin-bottom:var(--space-md);
    border-radius:var(--radius);
    border:none;
    background:var(--bg-card);
    color:white;
    font-size:14px;

    transition:var(--transition);
    outline:none;
}

/* Focus glow */
input:focus,
textarea:focus,
select:focus{
    background:var(--bg-accent);
    box-shadow:0 0 0 2px var(--accent);
}

/* Textarea usability */
textarea{
    resize:vertical;
    min-height:120px;
}

/* Select reset */
select{
    appearance:none;
    cursor:pointer;
}

/* =========================
   BUTTON SYSTEM
========================= */
button{
    width:100%;
    padding:16px;
    border:none;
    border-radius:var(--radius);
    margin-bottom:12px;
    font-size:16px;
    font-weight:600;
    cursor:pointer;

    transition:var(--transition);
}

/* Variants */
.btn-primary{
    background:var(--accent);
}

.btn-danger{
    background:var(--danger);
}

/* Hover / Active */
button:hover{
    transform:translateY(-1px);
    filter:brightness(1.05);
}

button:active{
    transform:translateY(0);
    filter:brightness(.95);
}

/* =========================
   AVATAR PREVIEW
========================= */
.avatarPreview{
    width:140px;
    height:140px;
    border-radius:50%;
    object-fit:cover;
    background:var(--bg-accent);
    display:block;
    margin:0 auto var(--space-md) auto;
}

/* =========================
   CANVAS EDITOR
========================= */
#editorContainer{
    display:none;
    margin-bottom:var(--space-lg);
}

canvas{
    width:260px;
    height:260px;
    border-radius:50%;
    display:block;
    margin:0 auto var(--space-sm) auto;
    background:#000;
}

#zoomSlider{
    width:100%;
    margin-bottom:var(--space-sm);
}

/* =========================
   UTILITY HELPERS
========================= */
.center{
    display:flex;
    justify-content:center;
    align-items:center;
}

.stack > * + *{
    margin-top:var(--space-md);
}

.hidden{
    display:none !important;
}

/* =========================
   MOBILE TWEAKS
========================= */
@media (max-width:480px){
    body{
        padding:var(--space-md);
    }

    canvas{
        width:220px;
        height:220px;
    }

    .avatarPreview{
        width:120px;
        height:120px;
    }
}

/* Base button */
.btn{
    width:100%;
    padding:16px;
    border:none;
    border-radius:var(--radius);
    font-size:16px;
    font-weight:600;
    cursor:pointer;
    transition:0.18s ease;
}

/* SAVE */
.saveBtn{
    background:var(--accent);
    color:white;
}

.saveBtn:hover{
    filter:brightness(1.1);
}

.saveBtn:active{
    filter:brightness(.9);
}


/* DELETE */
.deleteBtn{
    background:var(--danger);
    color:white;
}

.deleteBtn:hover{
    filter:brightness(1.1);
}

.deleteBtn:active{
    filter:brightness(.9);
}


</style>
</head>

<body>

<!-- HTML START -->

<h1>Edit Character</h1>

<img id="avatarPreview" class="avatarPreview">

<input type="file" id="charImage" accept="image/*">

<div id="editorContainer">
    <canvas id="imageCanvas" width="300" height="300"></canvas>
    <input type="range" id="zoomSlider" min="0.5" max="3" step="0.01" value="1">
    <button type="button" id="useImageBtn">Use Image</button>
</div>

<button type="button" id="freeformBtn" class="btn hidden">
    Freeform Edit
</button>

<input id="charName" placeholder="Name">
<textarea id="charDesc" placeholder="Description"></textarea>
<input id="charTags" placeholder="Tags">
<input id="charFolder" placeholder="Folder">

<h2 style="margin-top:20px;">Life Timeline</h2>

<input type="date" id="charBirthDate" placeholder="Birth Date">
<input type="date" id="charDeathDate" placeholder="Death Date">


<div id="autoStats" style="
background:var(--bg-card);
padding:14px;
border-radius:var(--radius);
margin-bottom:16px;
font-size:14px;
color:#9aa3b2;
">
</div>


<h2 style="margin-top:20px;">Custom Fields</h2>

<div id="customFieldsList"></div>

<button type="button" id="addCustomFieldBtn">
+ Add Custom Field
</button>


<h2 style="margin-top:20px;">Lore Metadata</h2>

<input id="charSpecies" placeholder="Species">
<input id="charFaction" placeholder="Faction">
<input id="charOrigin" placeholder="Origin World / Location">

<select id="charAlignment">
    <option value="">Alignment</option>
    <option>Hero</option>
    <option>Neutral</option>
    <option>Villain</option>
    <option>Anti-Hero</option>
    <option>Anti-Villain</option>
</select>


<div class="form-section">
    <h3>Abilities</h3>

    <div id="abilityList"></div>

    <button type="button" id="addAbilityBtn">+ Add Ability</button>
</div>



<h2 style="margin-top:20px;">Relationships</h2>

<div id="relationshipList"></div>

<button type="button" id="addRelationshipBtn">
+ Add Relationship
</button>

<button class="saveBtn" id="saveBtn">Save Changes</button>
<button class="btn deleteBtn" id="deleteCharacterBtn">
    Delete Character
</button>







<!-- HTML END -->




<!-- JAVA SCRIPT -->

<script>

/* =========================
   LOAD CHARACTER
========================= */
let characters = JSON.parse(localStorage.getItem("characters")) || [];
let editingId = localStorage.getItem("editingCharacterId");
let char = characters.find(c => c.id === editingId);

if(!char){
    alert("No character selected.");
    window.location.href = "character.html";
}

if(!char.freeform){
    char.freeform = { html:"", css:"" };
}

/* =========================
   ELEMENT REFERENCES
========================= */
const htmlInput = document.getElementById("htmlInput");
const cssInput = document.getElementById("cssInput");
const htmlHighlight = document.getElementById("htmlHighlight");
const cssHighlight = document.getElementById("cssHighlight");
const errorPanel = document.getElementById("errorPanel");

const previewBtn = document.getElementById("previewBtn");
const previewOverlay = document.getElementById("previewOverlay");
const previewFrame = document.getElementById("previewFrame");
const closePreview = document.getElementById("closePreview");

/* =========================
   INITIAL LOAD
========================= */
htmlInput.value = char.freeform.html || "";
cssInput.value = char.freeform.css || "";

/* =========================
   SAVE
========================= */
document.getElementById("saveBtn").addEventListener("click", ()=>{
    char.freeform.html = htmlInput.value;
    char.freeform.css = cssInput.value;
    char.updatedAt = new Date().toISOString();
    localStorage.setItem("characters", JSON.stringify(characters));
    alert("Freeform profile saved.");
});

/* =========================
   SANITIZER (STRICT)
========================= */
function sanitizeHTMLStrict(input){

    if(!input) return "";

    input = input.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, "");
    input = input.replace(/\son\w+="[^"]*"/gi, "");
    input = input.replace(/\son\w+='[^']*'/gi, "");
    input = input.replace(/javascript:/gi, "");
    input = input.replace(/<iframe[\s\S]*?>[\s\S]*?<\/iframe>/gi, "");
    input = input.replace(/<object[\s\S]*?>[\s\S]*?<\/object>/gi, "");
    input = input.replace(/<embed[\s\S]*?>/gi, "");

    return input;
}

/* =========================
   TEMPLATE VARIABLES
========================= */
function applyTemplate(html){

    const replacements = {
        "{{name}}": char.name || "",
        "{{desc}}": char.desc || "",
        "{{tags}}": char.tags || "",
        "{{folder}}": char.folder || "",
        "{{image}}": char.image || ""
    };

    Object.keys(replacements).forEach(key=>{
        html = html.split(key).join(replacements[key]);
    });

    return html;
}

/* =========================
   SECURE PREVIEW (SANDBOXED)
========================= */
previewBtn.addEventListener("click", ()=>{

    let safeHTML = sanitizeHTMLStrict(htmlInput.value);
    safeHTML = applyTemplate(safeHTML);

    let safeCSS = sanitizeHTMLStrict(cssInput.value);

    const finalDoc = `
        <!DOCTYPE html>
        <html>
        <head>
            <style>
                body{
                    margin:0;
                    padding:20px;
                    font-family:sans-serif;
                }
                ${safeCSS}
            </style>
        </head>
        <body>
            ${safeHTML}
        </body>
        </html>
    `;

    previewFrame.setAttribute("sandbox", "");
    previewFrame.srcdoc = finalDoc;

    previewOverlay.style.display = "flex";
});

closePreview.addEventListener("click", ()=>{
    previewOverlay.style.display = "none";
});

/* =========================
   SYNTAX HIGHLIGHTING
========================= */
function escapeHTML(str){
    return str
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;");
}

function highlightHTML(code){

    code = escapeHTML(code);

    code = code.replace(/(\{\{.*?\}\})/g,
        '<span class="token-template">$1</span>');

    code = code.replace(/(&lt;|&gt;)/g,
        '<span class="token-bracket">$1</span>');

    code = code.replace(/(&lt;\/?[a-zA-Z0-9-]+)/g,
        '<span class="token-tag">$1</span>');

    code = code.replace(/([a-zA-Z-:]+)=/g,
        '<span class="token-attr">$1</span>=');

    code = code.replace(/(".*?"|'.*?')/g,
        '<span class="token-string">$1</span>');

    return code;
}

function highlightCSS(code){

    code = escapeHTML(code);

    code = code.replace(/(^|\n)([^\{\}\n]+)(?=\s*\{)/g,
        '$1<span class="token-tag">$2</span>');

    code = code.replace(/([a-zA-Z-]+)(?=\s*:)/g,
        '<span class="token-attr">$1</span>');

    code = code.replace(/:\s*([^;]+)/g,
        ': <span class="token-string">$1</span>');

    return code;
}

/* =========================
   ERROR DETECTION
========================= */
function detectErrors(html, css){

    let errors = [];
    const tagStack = [];
    const voidTags = ["img","br","hr","input","meta","link"];

    const tagRegex = /<\/?([a-zA-Z0-9-]+)[^>]*>/g;
    let match;

    while((match = tagRegex.exec(html)) !== null){

        const fullTag = match[0];
        const tagName = match[1].toLowerCase();

        if(voidTags.includes(tagName)) continue;

        if(fullTag.startsWith("</")){
            if(tagStack[tagStack.length - 1] === tagName){
                tagStack.pop();
            } else {
                errors.push(`Unexpected closing tag: </${tagName}>`);
            }
        } else if(!fullTag.endsWith("/>")){
            tagStack.push(tagName);
        }
    }

    if(tagStack.length > 0){
        errors.push(`Unclosed tag: <${tagStack[tagStack.length - 1]}>`);
    }

    let openBraces = (css.match(/{/g) || []).length;
    let closeBraces = (css.match(/}/g) || []).length;

    if(openBraces !== closeBraces){
        errors.push("Unmatched { } in CSS.");
    }

    if(/<script/i.test(html)){
        errors.push("Script tags are not allowed.");
    }

    return errors;
}

/* =========================
   LIVE UPDATE
========================= */
function updateEditors(){

    const htmlCode = htmlInput.value;
    const cssCode = cssInput.value;

    htmlHighlight.innerHTML = highlightHTML(htmlCode);
    cssHighlight.innerHTML = highlightCSS(cssCode);

    const errors = detectErrors(htmlCode, cssCode);

    if(errors.length > 0){
        errorPanel.style.color = "#ff5a7a";
        errorPanel.innerHTML = errors.join("<br>");
    } else {
        errorPanel.style.color = "#7CFC9F";
        errorPanel.innerHTML = "âœ“ No syntax errors detected.";
    }
}

htmlInput.addEventListener("input", updateEditors);
cssInput.addEventListener("input", updateEditors);

/* Scroll sync */
function syncScroll(textarea, highlight){
    highlight.scrollTop = textarea.scrollTop;
    highlight.scrollLeft = textarea.scrollLeft;
}

htmlInput.addEventListener("scroll", ()=>{
    syncScroll(htmlInput, htmlHighlight);
});

cssInput.addEventListener("scroll", ()=>{
    syncScroll(cssInput, cssHighlight);
});

updateEditors();

</script>


</body>
</html>
