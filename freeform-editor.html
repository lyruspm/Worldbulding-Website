<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Freeform Profile Editor</title>

<style>
:root{
    --bg-main:#0d0f14;
    --bg-panel:#161a23;
    --bg-elev:#1c2130;
    --bg-input:#11151d;
    --accent:#5aa2ff;
    --accent-soft:rgba(90,162,255,0.15);
    --danger:#ff5a7a;
    --text-main:#e6e9ef;
    --text-dim:#9aa3b2;
    --border:#252b3a;
    --radius:14px;
    --radius-sm:10px;
    --shadow:0 10px 30px rgba(0,0,0,0.4);
}

/* =========================
   BASE
========================= */

body{
    margin:0;
    padding:32px;
    background:linear-gradient(180deg,#0d0f14 0%, #0f1117 100%);
    color:var(--text-main);
    font-family:Inter, system-ui, -apple-system, sans-serif;
    letter-spacing:0.2px;
}

h1{
    margin:0 0 28px 0;
    font-weight:700;
    font-size:28px;
    letter-spacing:0.5px;
}

label{
    display:block;
    margin-bottom:8px;
    font-size:13px;
    font-weight:600;
    color:var(--text-dim);
    text-transform:uppercase;
    letter-spacing:1px;
}

/* =========================
   TEXTAREAS
========================= */

textarea{
    width:100%;
    min-height:220px;
    background:var(--bg-input);
    color:var(--text-main);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:16px;
    margin-bottom:24px;
    resize:vertical;
    font-family:Consolas, Monaco, monospace;
    font-size:13px;
    line-height:1.5;
    transition:all 0.2s ease;
    box-shadow:inset 0 0 0 1px transparent;
}

textarea:focus{
    outline:none;
    border-color:var(--accent);
    box-shadow:0 0 0 3px var(--accent-soft);
}

/* Scrollbar styling */
textarea::-webkit-scrollbar{
    width:8px;
}
textarea::-webkit-scrollbar-thumb{
    background:#2a3142;
    border-radius:8px;
}

/* =========================
   BUTTONS
========================= */

button{
    width:100%;
    padding:14px;
    border:none;
    border-radius:var(--radius);
    margin-bottom:14px;
    font-weight:600;
    font-size:14px;
    cursor:pointer;
    transition:all 0.2s ease;
    box-shadow:var(--shadow);
}

button:hover{
    transform:translateY(-2px);
}

button:active{
    transform:translateY(0);
}

/* Primary */
#saveBtn{
    background:var(--accent);
    color:white;
}

#saveBtn:hover{
    box-shadow:0 0 18px var(--accent-soft);
}

/* Secondary */
.secondary{
    background:var(--bg-elev);
    color:var(--text-main);
    border:1px solid var(--border);
}

.secondary:hover{
    background:#22283a;
}

/* =========================
   PREVIEW OVERLAY
========================= */

.preview-overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.8);
    backdrop-filter:blur(6px);
    display:none;
    justify-content:center;
    align-items:center;
    padding:40px;
    z-index:999;
}

.preview-box{
    width:100%;
    max-width:1000px;
    height:90%;
    background:var(--bg-panel);
    border-radius:var(--radius);
    overflow:auto;
    position:relative;
    box-shadow:0 20px 60px rgba(0,0,0,0.6);
    border:1px solid var(--border);
    animation:fadeIn 0.2s ease;
}

@keyframes fadeIn{
    from{ opacity:0; transform:scale(0.98); }
    to{ opacity:1; transform:scale(1); }
}

/* Close Button */
.close-btn{
    position:absolute;
    top:16px;
    right:16px;
    background:var(--danger);
    border:none;
    padding:6px 14px;
    border-radius:var(--radius-sm);
    color:white;
    font-size:12px;
    font-weight:600;
    cursor:pointer;
    transition:all 0.2s ease;
}

.close-btn:hover{
    box-shadow:0 0 14px rgba(255,90,122,0.4);
}

#previewRoot{
    padding:32px;
}

/* =========================
   DEFAULT PROFILE STYLING
========================= */

.profile{
    background:var(--bg-elev);
    padding:28px;
    border-radius:var(--radius);
    border:1px solid var(--border);
    box-shadow:var(--shadow);
}

.profile img{
    width:200px;
    border-radius:50%;
    display:block;
    margin-bottom:16px;
    border:4px solid var(--accent-soft);
}

/* =========================
   CODE EDITOR
========================= */

.editor{
    position:relative;
    margin-bottom:24px;
}

.editor textarea,
.editor .highlight{
    font-family:Consolas, Monaco, monospace;
    font-size:13px;
    line-height:1.6;
    padding:16px;
    border-radius:14px;
}

.editor textarea{
    position:relative;
    inset:0;
    width:100%;
    height:100%;
    resize:vertical;
    background:transparent;
    color:transparent;
    caret-color:#5aa2ff;
    border:1px solid #252b3a;
    z-index:2;
    margin-bottom:24px;
    min-height:220px;
}

.editor .highlight{
    background:#11151d;
    border:1px solid #252b3a;
    white-space:pre-wrap;
    word-wrap:break-word;
    color:#e6e9ef;
    min-height:220px;
}

/* Syntax Colors */
.token-tag{ color:#5aa2ff; }
.token-bracket{ color:#ff7edb; }
.token-attr{ color:#ffd166; }
.token-string{ color:#7CFC9F; }
.token-template{ color:#ff9f43; }
.token-error{ background:rgba(255,90,122,0.2); color:#ff5a7a; }

/* Error Panel */
#errorPanel{
    background:#1c2130;
    border:1px solid #252b3a;
    padding:12px;
    border-radius:10px;
    font-size:13px;
    color:#ff5a7a;
    margin-bottom:20px;
}

#errorPanel:empty{
    display:none;
}

</style>
</head>

<body>

<h1>Freeform Profile Editor</h1>

<label>HTML Layout</label>

<div class="editor">
    <pre class="highlight" id="htmlHighlight"></pre>
    <textarea id="htmlInput" spellcheck="false"></textarea>
</div>

<div class="editor">
    <pre class="highlight" id="cssHighlight"></pre>
    <textarea id="cssInput" spellcheck="false"></textarea>
</div>

<div id="errorPanel"></div>

<button id="saveBtn">Save Profile</button>
<button class="secondary" id="previewBtn">Preview</button>

<div class="preview-overlay" id="previewOverlay">
    <div class="preview-box">
        <button class="close-btn" id="closePreview">Close</button>
        <div id="previewRoot"></div>
    </div>
</div>

<script>

/* =========================
   LOAD CHARACTER
========================= */
let characters = JSON.parse(localStorage.getItem("characters")) || [];
let editingId = localStorage.getItem("editingCharacterId");
let char = characters.find(c => c.id === editingId);

if(!char){
    alert("No character selected.");
    window.location.href = "character.html";
}

if(!char.freeform){
    char.freeform = { html:"", css:"" };
}

const htmlInput = document.getElementById("htmlInput");
const cssInput = document.getElementById("cssInput");
htmlInput.value = char.freeform.html || "";
cssInput.value = char.freeform.css || "";


/* =========================
   SAVE
========================= */
document.getElementById("saveBtn").addEventListener("click", ()=>{
    char.freeform.html = htmlInput.value;
    char.freeform.css = cssInput.value;
    char.updatedAt = new Date().toISOString();
    localStorage.setItem("characters", JSON.stringify(characters));
    alert("Freeform profile saved.");
});


/* =========================
   STRICT SANITIZER (JS FULLY DISABLED)
========================= */
function sanitizeHTML(input){

    // Remove script tags completely
    input = input.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, "");

    // Remove inline event handlers
    input = input.replace(/\son\w+\s*=\s*(".*?"|'.*?'|[^\s>]+)/gi, "");

    // Remove javascript: urls
    input = input.replace(/javascript:/gi, "");

    return input;
}


/* =========================
   TEMPLATE VARIABLES
========================= */
function applyTemplate(html){
    const replacements = {
        "{{name}}": char.name || "",
        "{{desc}}": char.desc || "",
        "{{tags}}": char.tags || "",
        "{{folder}}": char.folder || "",
        "{{image}}": char.image || ""
    };

    Object.keys(replacements).forEach(key=>{
        html = html.split(key).join(replacements[key]);
    });

    return html;
}


/* =========================
   PREVIEW
========================= */
const previewBtn = document.getElementById("previewBtn");
const previewOverlay = document.getElementById("previewOverlay");
const previewRoot = document.getElementById("previewRoot");
const closePreview = document.getElementById("closePreview");

previewBtn.addEventListener("click", ()=>{

    let safeHTML = sanitizeHTML(htmlInput.value);
    safeHTML = applyTemplate(safeHTML);
    const safeCSS = sanitizeHTML(cssInput.value);

    previewRoot.innerHTML = `
        <style>${safeCSS}</style>
        ${safeHTML}
    `;

    previewOverlay.style.display = "flex";
});

closePreview.addEventListener("click", ()=>{
    previewOverlay.style.display = "none";
});


/* =========================
   ESCAPE
========================= */
function escapeHTML(str){
    return str.replace(/&/g,"&amp;")
              .replace(/</g,"&lt;")
              .replace(/>/g,"&gt;");
}


/* =========================
   SYNTAX HIGHLIGHTING
========================= */

function highlightHTML(code){
    code = escapeHTML(code);

    code = code.replace(/(\{\{.*?\}\})/g,
        '<span class="token-template">$1</span>');

    code = code.replace(/(&lt;|&gt;)/g,
        '<span class="token-bracket">$1</span>');

    code = code.replace(/(&lt;\/?[a-zA-Z0-9-]+)/g,
        '<span class="token-tag">$1</span>');

    code = code.replace(/([a-zA-Z-:]+)=/g,
        '<span class="token-attr">$1</span>=');

    code = code.replace(/(".*?"|\'.*?\')/g,
        '<span class="token-string">$1</span>');

    return code;
}

function highlightCSS(code){
    code = escapeHTML(code);

    code = code.replace(/(^|\n)([^\{\}\n]+)(?=\s*\{)/g,
        '$1<span class="token-tag">$2</span>');

    code = code.replace(/([a-zA-Z-]+)(?=\s*:)/g,
        '<span class="token-attr">$1</span>');

    code = code.replace(/:\s*([^;]+)/g,
        ': <span class="token-string">$1</span>');

    return code;
}


/* =========================
   ERROR DETECTION
========================= */

function detectErrors(html, css){

    let errors = [];

    const voidTags = ["br","hr","img","input","meta","link","area","base","col","embed","param","source","track","wbr"];

    const tagStack = [];
    const tagRegex = /<\/?([a-zA-Z0-9-]+)[^>]*>/g;
    let match;

    while((match = tagRegex.exec(html)) !== null){
        const fullTag = match[0];
        const tagName = match[1].toLowerCase();

        if(voidTags.includes(tagName)) continue;

        if(fullTag.startsWith("</")){
            if(tagStack[tagStack.length - 1] === tagName){
                tagStack.pop();
            } else {
                errors.push(`Unexpected closing tag: </${tagName}>`);
            }
        } else if(!fullTag.endsWith("/>")){
            tagStack.push(tagName);
        }
    }

    if(tagStack.length > 0){
        errors.push(`Unclosed tag: <${tagStack[tagStack.length - 1]}>`);
    }

    let openBraces = (css.match(/{/g) || []).length;
    let closeBraces = (css.match(/}/g) || []).length;

    if(openBraces !== closeBraces){
        errors.push("Unmatched { } in CSS.");
    }

    if(/<script/i.test(html)){
        errors.push("Script tags are not allowed.");
    }

    if(/javascript:/i.test(html)){
        errors.push("javascript: URLs are not allowed.");
    }

    return errors;
}


/* =========================
   LIVE UPDATE
========================= */

const htmlHighlight = document.getElementById("htmlHighlight");
const cssHighlight = document.getElementById("cssHighlight");
const errorPanel = document.getElementById("errorPanel");

function updateEditors(){

    const htmlCode = htmlInput.value;
    const cssCode = cssInput.value;

    htmlHighlight.innerHTML = highlightHTML(htmlCode);
    cssHighlight.innerHTML = highlightCSS(cssCode);

    const errors = detectErrors(htmlCode, cssCode);

    if(errors.length > 0){
        errorPanel.style.color = "#ff5a7a";
        errorPanel.innerHTML = errors.join("<br>");
    } else {
        errorPanel.style.color = "#7CFC9F";
        errorPanel.innerHTML = "âœ“ No syntax errors detected.";
    }
}

htmlInput.addEventListener("input", updateEditors);
cssInput.addEventListener("input", updateEditors);

/* Scroll sync (X + Y) */
htmlInput.addEventListener("scroll", ()=>{
    htmlHighlight.scrollTop = htmlInput.scrollTop;
    htmlHighlight.scrollLeft = htmlInput.scrollLeft;
});

cssInput.addEventListener("scroll", ()=>{
    cssHighlight.scrollTop = cssInput.scrollTop;
    cssHighlight.scrollLeft = cssInput.scrollLeft;
});

updateEditors();

</script>

</body>
</html>
